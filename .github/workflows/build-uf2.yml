name: Build Pico W HTTPD

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # ---- Checkout your repository ----
    - name: Checkout source
      uses: actions/checkout@v4

    # ---- Install build dependencies ----
    - name: Install build tools
      run: |
        sudo apt update
        sudo apt install -y gcc-arm-none-eabi binutils-arm-none-eabi cmake make

    # ---- Clone Pico SDK ----
    - name: Clone Pico SDK
      run: |
        git clone --branch 2.1.0 --depth=1 https://github.com/raspberrypi/pico-sdk.git
        cd pico-sdk
        git submodule update --init --recursive
        echo "PICO_SDK_PATH=${GITHUB_WORKSPACE}/pico-sdk" >> $GITHUB_ENV

    # ---- Configure project ----
    - name: Configure project with CMake
      run: |
        mkdir -p build
        cd build
        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE=${{ env.PICO_SDK_PATH }}/cmake/preload/toolchains/pico_arm_cortex_m0plus_gcc.cmake \
          -DPICO_BOARD=pico_w \
          -DPICO_SDK_PATH=${{ env.PICO_SDK_PATH }}

    # ---- Build project ----
    - name: Build project
      run: |
        cd build
        make -j$(nproc)

    # ---- Upload build artifacts ----
    - name: Upload build outputs
      uses: actions/upload-artifact@v4
      with:
        name: pico_w_httpd
        path: |
          build/*.uf2
          build/*.elf
          build/*.bin
