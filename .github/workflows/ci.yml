name: Build Pico 2W LTE Router

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-docker:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build using official Pico Docker image
      run: |
        # Pull the official Raspberry Pi Pico SDK Docker image
        docker pull raspberrypi/pico-sdk
        
        # Run build in Docker container
        docker run --rm \
          -v $PWD:/project \
          -w /project \
          raspberrypi/pico-sdk \
          /bin/bash -c "
            echo '=== Building in Docker ==='
            mkdir -p build
            cd build
            cmake -DPICO_BOARD=pico_w ..
            make pico2w_lte_router -j4
            ls -la *.uf2
            echo '=== Build complete ==='
          "
        
    - name: Copy artifacts from Docker build
      run: |
        # Copy the built UF2 file from the build directory
        if [ -f "build/pico2w_lte_router.uf2" ]; then
          echo "✅ UF2 file found"
          ls -la build/*.uf2
        else
          echo "❌ No UF2 file found after Docker build"
          find build -name "*.uf2" -o -name "*.elf" | head -10
          exit 1
        fi
        
    - name: Download official comparison
      run: |
        wget -q -O official_blink.uf2 "https://rptl.io/pico-blink" || echo "Could not download official UF2"
        
    - name: Upload all firmware files
      uses: actions/upload-artifact@v4
      with:
        name: pico2w-firmware-docker
        path: |
          build/pico2w_lte_router.uf2
          official_blink.uf2
        retention-days: 7
